<div class="card" draggable="true" ondragstart="dragCard(event)" ondragend="dragEnd(event)" data-card="{{ card.id }}" onclick="selectCard(this)">
  <div class="card-header">
    <strong>{{ card.title }}</strong>
    {% if card.due_at %}
      {% set days_diff = (card.due_at.date() - today).days if today else 0 %}
      <span class="badge {% if days_diff < 0 %}due-overdue{% elif days_diff == 0 %}due-today{% elif days_diff <= 3 %}due-soon{% endif %}">
        {% if days_diff < 0 %}Overdue{% elif days_diff == 0 %}Due Today{% else %}Due {{ card.due_at.strftime('%m/%d') }}{% endif %}
      </span>
    {% endif %}
  </div>

  {% if card.notes %}<div class="card-notes muted">{{ card.notes }}</div>{% endif %}
  
  {% set total_items = card.checklist|length if card.checklist else 0 %}
  {% set done_items = card.checklist|selectattr("done")|list|length if card.checklist else 0 %}
  
  {% if total_items > 0 %}
    <div class="checklist-summary">
      <span class="checklist-progress">{{ done_items }}/{{ total_items }}</span>
      <div class="checklist-bar">
        <div class="checklist-fill" style="width: {{ (done_items/total_items*100)|round }}%"></div>
      </div>
    </div>
  {% endif %}
  
  <div class="card-actions" style="display: none;">
    <button class="quick-action" onclick="quickDelete({{ card.id }})" title="Delete">×</button>
    <select class="quick-move" onchange="quickMove({{ card.id }}, this.value)" title="Move to...">
      <option value="">Move to...</option>
      <option value="1" {{ 'selected' if card.column_id == 1 else '' }}>Todo</option>
      <option value="2" {{ 'selected' if card.column_id == 2 else '' }}>Doing</option>
      <option value="3" {{ 'selected' if card.column_id == 3 else '' }}>Done</option>
    </select>
  </div>

  {% if (card.checklist or []) %}
    <details class="checklist-details" open>
      <summary>Checklist ({{ done_items }}/{{ total_items }})</summary>
      <ul class="checklist" id="checklist-{{ card.id }}">
        {% for it in card.checklist %}
          <li class="{{ 'checked' if it.done else '' }}" data-item-id="{{ it.id }}">
            <button type="button" class="check-btn" onclick="toggleChecklistItem({{ it.id }}, this)">{{ "☑" if it.done else "☐" }}</button>
            <span class="checklist-text {{ 'done' if it.done else '' }}">{{ it.text }}</span>
            <button type="button" class="delete-item-btn" onclick="deleteChecklistItem({{ it.id }}, this)" title="Delete item">×</button>
          </li>
        {% endfor %}
      </ul>

      <form class="add-checklist" onsubmit="addChecklistItem(event, {{ card.id }})">
        <input name="text" placeholder="Add checklist item..." autocomplete="off" onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); this.closest('form').dispatchEvent(new Event('submit')); }"/>
        <button type="submit">+</button>
      </form>
    </details>
  {% else %}
    <form class="add-checklist-first" style="margin-top: 8px;" onsubmit="addChecklistItem(event, {{ card.id }})">
      <input name="text" placeholder="+ Add checklist item" autocomplete="off" onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); this.closest('form').dispatchEvent(new Event('submit')); }"/>
    </form>
  {% endif %}

  {% if (card.children or []) %}
    <div class="subcards">
      {% for child in card.children %}
        {% set card = child %}
        {% include "_card.html" %}
      {% endfor %}
    </div>
  {% endif %}
</div>
